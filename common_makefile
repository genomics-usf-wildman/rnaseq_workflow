#!/usr/bin/make -f

SHELL=/bin/bash

-include project.mk

# this is the env variable to tell us how many processors on this node
# we get
ifdef PBS_NUM_PPN
CORES=$(PBS_NUM_PPN)
else
CORES=8
endif

### module is how the biocluster loads specific versions; if we're not
### running there, we'll assume the correct version is installed and
### just echo what we're loading
ifdef MODULEPATH
MODULE=module
else
MODULE=echo
endif

SPECIES?=homo_sapiens

REFERENCE_DIR?=
ENSEMBL_RELEASE?=84
GTF?=$(REFERENCE_DIR)Homo_sapiens.GRCh38.$(ENSEMBL_RELEASE).gtf
FASTA?=$(REFERENCE_DIR)Homo_sapiens.GRCh38.dna.toplevel.fa

STAR_INDEX_DIR?=$(REFERENCE_DIR)$(SPECIES)_star/

REMOTE_FILES=$(FASTA).gz $(GTF).gz


TRIMMED_FASTQ_FILES=$(patsubst %.fastq.gz,%_trimmed.fastq.gz,$(FASTQ_FILES))

UNTRIMMED_FASTQC_ANALYSIS_FILES=$(patsubst %.fastq.gz,%_fastqc.html,$(FASTQ_FILES))

TRIMMED_FASTQC_ANALYSIS_FILES=$(patsubst %.fastq.gz,%_fastqc.html,$(TRIMMED_FASTQ_FILES))

FASTQC_ANALYSIS_FILES=$(UNTRIMMED_FASTQC_ANALYSIS_FILES) $(TRIMMED_FASTQC_ANALYSIS_FILES)

ifdef USE_TRINITY
PROTEIN_ALIGNMENT_SPECIES?=$(ALIGNMENT_SPECIES)
PROTEIN_ALIGNMENT_FASTA?=$(patsubst %.dna.toplevel.fa,%.pep.all.fa,$(FASTA))
REMOTE_FILES:=$(REMOTE_FILES) $(PROTEIN_ALIGNMENT_FASTA)

CUFFLINKS_OPTIONS?=--max-bundle-frags=4000000 \
		--min-frags-per-transfrag 2
endif

ifeq ($(NREADS),1)
FPKM_GENES_ANALYSIS_FILES=$(patsubst %.fastq.gz,%_genes.fpkm_tracking,$(FASTQ_FILES))
STAR_ALIGNMENT_FILES=$(patsubst %.fastq.gz,%_star.bam,$(FASTQ_FILES))
else
FPKM_GENES_ANALYSIS_FILES=$(patsubst %_1.fastq.gz,%_genes.fpkm_tracking,$(filter %_1.fastq.gz,$(FASTQ_FILES)))
STAR_ALIGNMENT_FILES=$(patsubst %_1.fastq.gz,%_star.bam,$(filter %_1.fastq.gz,$(FASTQ_FILES)))
endif

CUFFLINKS_OPTIONS?=

# we need to use a comma in a rule below, so this handles that
# escaping
comma:=,
empty:=
space:= $(empty) $(empty)

# default rule
.DEFAULT:=all
all: call

# these rules are the rules that you might want to call separately
call: $(FPKM_GENES_ANALYSIS_FILES)

fastqc: $(FASTQC_ANALYSIS_FILES)

untrimmed-fastqc: $(UNTRIMMED_FASTQC_ANALYSIS_FILES)

trimmed-fastqc: $(TRIMMED_FASTQC_ANALYSIS_FILES)

alignment: $(STAR_ALIGNMENT_FILES)

star_indexes: $(STAR_INDEX_DIR)/SA

trim: $(TRIMMED_FASTQ_FILES)

remote_files: $(REMOTE_FILES)

fasta: $(FASTA)

gtf: $(GTF)

ifdef USE_TRINITY
%_genes.fpkm_tracking %_isoforms.fpkm_tracking %_skipped.gtf %_transcripts.gtf: %_star.bam
	mkdir -p $(*)_cufflinks;
	$(MODULE) load cufflinks/2.2.1; \
	cufflinks -o $(*)_cufflinks $(CUFFLINKS_OPTIONS) \
		-p $(CORES) $<
	for file in genes.fpkm_tracking isoforms.fpkm_tracking skipped.gtf transcripts.gtf; do \
		mv $(*)_cufflinks/$${file} $(*)_$${file}; \
	done;
	rm $(*)_cufflinks -rf;
else
%_genes.fpkm_tracking %_isoforms.fpkm_tracking %_skipped.gtf %_transcripts.gtf: %_star.bam $(GTF)
	mkdir -p $(*)_cufflinks;
	$(MODULE) load cufflinks/2.2.1; \
	cufflinks -o $(*)_cufflinks $(CUFFLINKS_OPTIONS) -p $(CORES) -G $(wordlist 2,2,$^) $<
	for file in genes.fpkm_tracking isoforms.fpkm_tracking skipped.gtf transcripts.gtf; do \
		mv $(*)_cufflinks/$${file} $(*)_$${file}; \
	done;
	rm $(*)_cufflinks -rf;
endif

$(FASTQC_ANALYSIS_FILES): %_fastqc.html: %.fastq.gz
	$(MODULE) load fastqc/0.11.2; \
	fastqc -t $(CORES) $<

ifdef USE_TRINITY
GENOME_FASTA=$(SPECIES)_trinity.Trinity.fasta
STAR_INDEX_OPTIONS?=--genomeChrBinNbits 9
else
GENOME_FASTA=$(FASTA)
STAR_INDEX_OPTIONS?=
endif

# use 150G, which is echo $((1024*1024*1024*150))
STAR_INDEX_MEMORY_LIMIT?=161061273600

$(STAR_INDEX_DIR)/SA: $(GENOME_FASTA)
	$(MODULE) load STAR/2.5.1b; \
	mkdir -p $(STAR_INDEX_DIR); \
	STAR --genomeFastaFiles  $(GENOME_FASTA) \
		--runMode genomeGenerate \
		$(STAR_INDEX_OPTIONS) \
		--limitGenomeGenerateRAM $(STAR_INDEX_MEMORY_LIMIT) \
		--runThreadN $(CORES) \
		--genomeDir $(STAR_INDEX_DIR)

STAR_OPTIONS?=

ifeq ($(NREADS),1)
%_star.bam: %_trimmed.fastq.gz $(STAR_INDEX_DIR)/SA
else
%_star.bam: %_1_trimmed.fastq.gz %_2_trimmed.fastq.gz $(STAR_INDEX_DIR)/SA
endif
	$(MODULE) load STAR/2.5.1b; \
	mkdir -p $(*)_star; \
	STAR --outFileNamePrefix $(*)_star/ \
		--outSAMtype BAM SortedByCoordinate \
		--runThreadN $(CORES) \
        --outSAMstrandField intronMotif \
		--genomeDir $(STAR_INDEX_DIR) \
		$(STAR_OPTIONS) \
		--readFilesCommand "gzip -dc" \
		--readFilesIn $(if $(filter-out $(NREADS),2),$(wordlist 1,1,$^),$(wordlist 1,1,$^)$(comma)$(wordlist 2,2,$^))
	ln $(*)_star/Aligned.sortedByCoord.out.bam $@ -sf

# This is the directory where the trimmomatic adapters are kept
ifdef MODULEPATH
TRIMMOMATIC_FASTA_PATH?=/home/apps/trimmomatic/trimmomatic-0.33/adapters
TRIMMOMATIC_PE=java org.usadellab.trimmomatic.TrimmomaticPE
TRIMMOMATIC_SE=java org.usadellab.trimmomatic.TrimmomaticSE
else
TRIMMOMATIC_PE=TrimmomaticPE
TRIMMOMATIC_SE=TrimmomaticSE
TRIMMOMATIC_FASTA_PATH?=/usr/share/trimmomatic
endif

## set the clip options for trimmomatic
TRIMMOMATIC_OPTIONS?=ILLUMINACLIP:$(TRIMMOMATIC_FASTA_PATH)/TruSeq2-SE.fa:2:20:10
TRIMMOMATIC_QUALITY?=

ifeq ($(NREADS),1)
$(TRIMMED_FASTQ_FILES): %_trimmed.fastq.gz: %.fastq.gz
	$(MODULE) load trimmomatic/0.33; \
	$(TRIMMOMATIC_SE) \
		-threads $(CORES) \
		$(TRIMMOMATIC_QUALITY) \
		$< $@ \
		$(TRIMMOMATIC_OPTIONS);
else
%_1_trimmed.fastq.gz %_2_trimmed.fastq.gz: %_1.fastq.gz %_2.fastq.gz
	$(MODULE) load trimmomatic/0.33; \
	$(TRIMMOMATIC_PE) \
		-threads $(CORES) \
		$(TRIMMOMATIC_QUALITY) \
		$(wordlist 1,1,$^) $(wordlist 2,2,$^) \
		$(*)_1_trimmed.fastq.gz /dev/null \
		$(*)_2_trimmed.fastq.gz /dev/null \
		$(TRIMMOMATIC_OPTIONS);
endif

ifdef USE_TRINITY
trinity: $(SPECIES)_trinity.Trinity.fasta

TRINITY_OPTIONS?=--max_memory 20G
ifeq ($(NREADS),1)
TRINITY_FASTQ_ARGUMENTS=--single $(subst $(space),$(comma),$(strip $(TRIMMED_FASTQ_FILES)))
else
TRINITY_FASTQ_ARGUMENTS= --left $(subst $(space),$(comma),$(strip $(filter %_1_trimmed.fastq.gz,$(TRIMMED_FASTQ_FILES)))) --right $(subst $(space),$(comma),$(strip $(filter %_2_trimmed.fastq.gz,$(TRIMMED_FASTQ_FILES))))
endif

$(SPECIES)_trinity.Trinity.fasta: $(TRIMMED_FASTQ_FILES)
	$(MODULE) load samtools/0.1.19; \
	$(MODULE) load trinityrnaseq/2.2.0; \
	Trinity --seqType fq \
	$(TRINITY_FASTQ_ARGUMENTS) \
	--CPU $(CORES) --output $(SPECIES)_trinity \
	$(TRINITY_OPTIONS)
	mv $(SPECIES)_trinity/Trinity.fasta $@


$(PROTEIN_ALIGNMENT_SPECIES)_diamond.dmnd: $(PROTEIN_ALIGNMENT_FASTA)
	$(MODULE) load diamond/0.7.9 ; \
	diamond makedb --threads $(CORES) \
		--in $(PROTEIN_ALIGNMENT_FASTA) \
		--db $(PROTEIN_ALIGNMENT_SPECIES)_diamond;

$(PROTEIN_ALIGNMENT_SPECIES)_diamond.dmnd: $(PROTEIN_ALIGNMENT_FASTA)
	$(MODULE) load diamond/0.7.9 ; \
	diamond makedb --threads $(CORES) \
		--in $(PROTEIN_ALIGNMENT_FASTA) \
		--db $(PROTEIN_ALIGNMENT_SPECIES)_diamond;


$(SPECIES)_trinity_diamond.daa: $(SPECIES)_trinity.Trinity.fasta \
	$(PROTEIN_ALIGNMENT_SPECIES)_diamond.dmnd
	$(MODULE) load diamond/0.7.9 ; \
	diamond blastx --db $(PROTEIN_ALIGNMENT_SPECIES)_diamond \
		--threads $(CORES) \
		--query $(SPECIES)_trinity.Trinity.fasta \
        --daa $(SPECIES)_trinity_diamond

diamond: $(SPECIES)_trinity_diamond.txt

$(SPECIES)_trinity_diamond.txt: $(SPECIES)_trinity_diamond.daa
	$(MODULE) load diamond/0.7.9 ; \
	diamond view --threads $(CORES) --daa $< > $@

$(PROTEIN_ALIGNMENT_FASTA).gz:
	rsync -avP "rsync://ftp.ensembl.org/ensembl/pub/release-$(ENSEMBL_RELEASE)/fasta/$(PROTEIN_ALIGNMENT_SPECIES)/pep/$(PROTEIN_ALIGNMENT_FASTA).gz" $@

$(PROTEIN_ALIGNMENT_FASTA): $(PROTEIN_ALIGNMENT_FASTA).gz
	gzip -dc $< > $@
endif

## this rule generates bam indexes in case you need to subset the bam
%.bam.bai: %.bam
	$(MODULE) load samtools; \
	samtools index $<

$(FASTA): $(FASTA).gz
	gzip -dc $< > $@

$(GTF): $(GTF).gz
	gzip -dc $< > $@

$(FASTA).gz:
	mkdir -p $(dir $@)
	rsync -avP "rsync://ftp.ensembl.org/ensembl/pub/release-$(ENSEMBL_RELEASE)/fasta/$(SPECIES)/dna/$(notdir $(FASTA)).gz" $@

$(GTF).gz:
	mkdir -p $(dir $@)
	rsync -avP "rsync://ftp.ensembl.org/ensembl/pub/release-$(ENSEMBL_RELEASE)/gtf/$(SPECIES)/$(notdir $(GTF)).gz" $@


## this file contains a variable that describes how to connect to the
## cluster host where I ran the analyses and will retreive them onto
## the local host for analysis
-include cluster_host.mk

get_results:
	rsync -avmP \
		--include '**_genes.fpkm_tracking' \
		--include '**_isoforms.fpkm_tracking' \
		--include '**_star/Log.final.out' \
		--include '**trinity_diamond.txt' \
		--include '**_trinity_align_rsem_isoforms.txt' \
        --include '**_fastqc.html' \
        --include '**_fastqc.zip' \
        --include '**/' \
	    --exclude '**' \
		$(CLUSTER_HOST)/ .;

